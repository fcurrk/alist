import{ai as p,a as P,aY as b,ba as _,m as h,h as t,ae as L,cf as j,ay as Y,S as m,aE as ce,ck as We,cl as Ge,bQ as se,d4 as oe,C as w,bb as S,n as W,ag as Q,a4 as N,cX as Ve,G as q,d5 as A,d6 as He,ci as de,k as C,e as Ue,x as Xe,I as je,af as O,E as F,t as Qe,cp as Ye,aN as G,cs as ie,d7 as ge,d8 as ue,ak as J}from"./index.fd15d69a.js";import{P as qe}from"./Paginator.09bff868.js";var z;(function(e){e[e.Pending=0]="Pending",e[e.Running=1]="Running",e[e.Succeeded=2]="Succeeded",e[e.Canceling=3]="Canceling",e[e.Canceled=4]="Canceled",e[e.Errored=5]="Errored",e[e.Failing=6]="Failing",e[e.Failed=7]="Failed",e[e.WaitingRetry=8]="WaitingRetry",e[e.BeforeRetry=9]="BeforeRetry"})(z||(z={}));const Je={[z.Failed]:"danger",[z.Succeeded]:"success",[z.Canceled]:"neutral"},Ke=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t(de,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},Ze=e=>{const n=P();return t(de,{get colorScheme(){var s;return(s=Je[e.state])!=null?s:"info"},get children(){return n(`tasks.state.${e.state}`)}})},c=[{name:"name",textAlign:"left",w:p().role===2?"calc(100% - 660px)":"calc(100% - 540px)"},{name:"creator",textAlign:"center",w:p().role===2?"120px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"160px"},{name:"operation",textAlign:"right",w:"280px"}],Ee=e=>{const n=P(),s=e.done==="undone"?"cancel":"delete",u=e.done==="done"&&e.state===z.Failed,[d,g]=b(()=>_.post(`/task/${e.type}/${s}?tid=${e.id}`)),[y,i]=b(()=>_.post(`/task/${e.type}/retry?tid=${e.id}`)),[$,v]=h(!1),x=e.name.match(e.nameAnalyzer.regex),V=x===null?e.name:e.nameAnalyzer.title(x);return t(m,{get when(){return!$()},get children(){return[t(L,{w:"$full",p:"$2",get children(){return[t(L,{get w(){return c[0].w},spacing:"$1",get children(){return[t(j,{"on:click":o=>{o.stopPropagation()},get checked(){return e.selected},onChange:o=>{e.setSelected(e.id,o.target.checked)}}),t(Y,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:V})]}}),t(m,{get when(){return p().role===2},get children(){return t(ce,{get w(){return c[1].w},get children(){return t(Ke,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(ce,{get w(){return c[2].w},get children(){return t(Ze,{get state(){return e.state}})}}),t(We,{get w(){return c[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},get children(){return t(Ge,{color:"$info8",rounded:"$md"})}}),t(se,{get w(){return c[4].w},gap:"$1",get children(){return[t(oe,{}),t(m,{get when(){return e.canRetry},get children(){return t(w,{disabled:!u,display:u?"block":"none",get loading(){return y()},onClick:async()=>{const o=await i();S(o,()=>{W.info(n("tasks.retry")),v(!0)})},get children(){return n("tasks.retry")}})}}),t(w,{colorScheme:"danger",get loading(){return d()},onClick:async()=>{const o=await g();S(o,()=>{W.success(n("global.delete_success")),v(!0)})},get children(){return n(`global.${s}`)}}),t(w,{colorScheme:"neutral",onClick:()=>{e.setExpanded(e.id,!e.expanded)},get children(){return Q(()=>!!e.expanded,!0)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(m,{get when(){return e.expanded},get children(){return t(N,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(Ve,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(m,{when:x!==null,get children(){return t(q,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:o=>[t(A,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return o[0]}}),t(A,{color:"$neutral9",get children(){return o[1](x)}})]})}}),t(A,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(A,{color:"$neutral9",get children(){return e.status}}),t(m,{get when(){return e.error},get children(){return[t(A,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(A,{color:"$danger9",get children(){return[Q(()=>e.error)," "]}})]}})]}}),t(He,{})]}})}})]}})},Te=e=>{const n=P(),[s,u]=b(()=>_.get(`/task/${e.type}/${e.done}`)),[d,g]=h([]),[y,i]=h("name"),[$,v]=h(!1),x={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress<a.progress?1:-1},V=C(()=>(r,a)=>($()?-1:1)*x[y()](r,a)),o=async()=>{var M,I;const r=await u(),a={},l={};for(const f of d())a[f.id]=(M=f.selected)!=null?M:!1,l[f.id]=(I=f.expanded)!=null?I:!1;S(r,f=>{var R;return g((R=f==null?void 0:f.map(X=>{var ae,le;return{...X,selected:(ae=a[X.id])!=null?ae:!1,expanded:(le=l[X.id])!=null?le:!1}}).sort(V()))!=null?R:[])})};if(o(),e.done==="undone"){const r=setInterval(o,2e3);Ue(()=>clearInterval(r))}const[$e,we]=b(()=>_.post(`/task/${e.type}/clear_done`)),[me,ye]=b(()=>_.post(`/task/${e.type}/clear_succeeded`)),[xe,pe]=b(()=>_.post(`/task/${e.type}/retry_failed`)),[K,ke]=h(""),[_e,ve]=h(new RegExp("")),[Ce,Z]=h(!1);Xe(()=>{try{ve(new RegExp(K())),Z(!1)}catch{Z(!0)}});const[E,Se]=h(p().role!==2),H=C(()=>{const r=_e(),a=E();return l=>r.test(l.name)&&(!a||l.creator===p().username)}),k=C(()=>d().filter(H())),T=C(()=>k().map(r=>r.selected).every(Boolean)),Re=C(()=>k().map(r=>r.selected).some(Boolean)&&!T()),Ae=(r,a)=>{g(d().map(l=>(l.id===r&&(l.selected=a),l)))},Fe=r=>{const a=H();g(d().map(l=>(a(l)&&(l.selected=r),l)))},ee=C(()=>k().map(r=>r.expanded).every(Boolean)),be=(r,a)=>{g(d().map(l=>(l.id===r&&(l.expanded=a),l)))},ze=r=>{const a=H();g(d().map(l=>(a(l)&&(l.expanded=r),l)))},te=(r,a,l)=>async()=>{r(!0);const M=k().filter(f=>f.selected).map(a);let I=!0;for(const f of M){const R=await f;if(R.code!==200&&(I=!1,S(R),R.code===401))return}r(!1),I&&(l==null||l())},[Pe,Be]=h(!1),Ie=te(Be,r=>_.post(`/task/${e.type}/retry?tid=${r.id}`),()=>{W.info(n("tasks.retry")),o()}),[Oe,Le]=h(!1),Ne=te(Le,r=>_.post(`/task/${e.type}/${re}?tid=${r.id}`),()=>{W.success(n("global.delete_success")),o()}),[De,Me]=h(1),U=20,re=e.done==="undone"?"cancel":"delete",ne=C(()=>{const r=(De()-1)*U,a=r+U;return k().slice(r,a)}),B=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),D=r=>({cursor:"pointer",onClick:()=>{y()===r.name?v(!$()):Qe(()=>{i(r.name),v(!1)}),o()}});return t(N,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(Y,{size:"lg",get children(){return n(`tasks.${e.done}`)}}),t(L,{gap:"$2",flexWrap:"wrap",get children(){return[t(m,{get when(){return e.done==="done"},get children(){return[t(w,{colorScheme:"accent",get loading(){return s()},onClick:o,get children(){return n("global.refresh")}}),t(w,{get loading(){return xe()},onClick:async()=>{const r=await pe();S(r,()=>o())},get children(){return n("tasks.retry_failed")}}),t(w,{colorScheme:"danger",get loading(){return $e()},onClick:async()=>{const r=await we();S(r,()=>o())},get children(){return n("global.clear")}}),t(w,{colorScheme:"success",get loading(){return me()},onClick:async()=>{const r=await ye();S(r,()=>o())},get children(){return n("tasks.clear_succeeded")}})]}}),t(m,{get when(){return e.canRetry},get children(){return t(w,{colorScheme:"primary",get loading(){return Pe()},onClick:Ie,get children(){return n("tasks.retry_selected")}})}}),t(w,{colorScheme:"warning",get loading(){return Oe()},onClick:Ne,get children(){return n(`tasks.${re}_selected`)}}),t(je,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return K()},onInput:r=>ke(r.target.value),get invalid(){return Ce()}}),t(m,{get when(){return p().role===2},get children(){return t(j,{get checked(){return E()},onChange:r=>Se(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(N,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(L,{class:"title",w:"$full",p:"$2",get children(){return[t(L,{get w(){return c[0].w},spacing:"$1",get children(){return[t(j,{get disabled(){return k().length===0},get checked(){return T()},get indeterminate(){return Re()},onChange:r=>Fe(r.target.checked)}),t(O,F(()=>B(c[0]),()=>D(c[0]),{get children(){return n(`tasks.attr.${c[0].name}`)}}))]}}),t(m,{get when(){return p().role===2},get children(){return t(O,F({get w(){return c[1].w}},()=>B(c[1]),()=>D(c[1]),{get children(){return n(`tasks.attr.${c[1].name}`)}}))}}),t(O,F({get w(){return c[2].w}},()=>B(c[2]),()=>D(c[2]),{get children(){return n(`tasks.attr.${c[2].name}`)}})),t(O,F({get w(){return c[3].w}},()=>B(c[3]),()=>D(c[3]),{get children(){return n(`tasks.attr.${c[3].name}`)}})),t(se,{get w(){return c[4].w},gap:"$2",get children(){return[t(oe,{}),t(O,F(()=>B(c[4]),{get children(){return n(`tasks.attr.${c[4].name}`)}})),t(w,{size:"xs",colorScheme:"neutral",onClick:()=>ze(!ee()),get disabled(){return k().length===0},get children(){return Q(()=>!!ee(),!0)()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),t(q,{get each(){return ne()},children:(r,a)=>t(Ee,F(()=>ne()[a()],e,{setSelected:Ae,setExpanded:be}))})]}}),t(qe,{get total(){return k().length},defaultPageSize:U,onChange:r=>{Me(r)}})]}})},at=e=>{const n=P();return t(N,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(Y,{size:"xl",get children(){return n(`tasks.${e.type}`)}}),t(N,{w:"$full",spacing:"$2",get children(){return t(q,{each:["undone","done"],children:s=>t(Te,{get type(){return e.type},done:s,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})},et=J("<a></a>"),he=J("<p></p>"),tt=J('<a target="_blank"></a>'),fe=(e,n)=>{const s=(e==="/"?"":e)+n,u=p().base_path==="/"?"":p().base_path,d=s.startsWith(u),[g,y]=h(!1);return d?(()=>{const i=et.cloneNode(!0);return i.$$mouseout=()=>y(!1),i.$$mouseover=()=>y(!0),G(i,s),ie($=>{const v=g()?"text-decoration: underline":"",x=s.slice(u.length);return $._v$=ge(i,v,$._v$),x!==$._v$2&&ue(i,"href",$._v$2=x),$},{_v$:void 0,_v$2:void 0}),i})():(()=>{const i=he.cloneNode(!0);return G(i,s),i})()},lt=()=>{const e=P(),[n,s]=h(!1);return{regex:/^download (.+) to \((.+)\)$/,title:u=>u[1],attrs:{[e("tasks.attr.offline_download.url")]:u=>(()=>{const d=tt.cloneNode(!0);return d.$$mouseout=()=>s(!1),d.$$mouseover=()=>s(!0),G(d,()=>u[1]),ie(g=>{const y=n()?"text-decoration: underline":"",i=u[1];return g._v$3=ge(d,y,g._v$3),i!==g._v$4&&ue(d,"href",g._v$4=i),g},{_v$3:void 0,_v$4:void 0}),d})(),[e("tasks.attr.offline_download.path")]:u=>fe("",u[2])}}},ct=()=>{const e=P();return{regex:/^transfer ((?:.*\/)?(.+)) to \[(.+)]$/,title:n=>n[2],attrs:{[e("tasks.attr.offline_download.transfer_src")]:n=>(()=>{const s=he.cloneNode(!0);return G(s,()=>n[1]),s})(),[e("tasks.attr.offline_download.transfer_dst")]:n=>fe("",n[3])}}};Ye(["mouseover","mouseout"]);export{at as T,ct as a,fe as b,lt as g};
