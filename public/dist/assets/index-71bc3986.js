import{ch as ie,a7 as T,x as e,ao as le,an as y,a4 as v,d as H,cd as C,ci as k,r as q,aP as J,br as b,c2 as ce,cj as ue,ck as ge,cl as de,cm as pe,b as he,A as me,B as p,cn as fe,ba as U,q as we,ai as be,bX as A,aN as Ce,S as f,L as M,bc as j,av as ke,Q as O,bC as _e,bD as Se,co as $e,aT as ve,n as w,bs as ye,cp as G}from"./index-f9f2b6aa.js";import{a as Ie}from"./useTitle-cba4706d.js";import{s as Le,g as xe,a as Ee}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Pe="https://github.com/fcurrk/alist";function Re(i){return ie(`${i}-${Pe}`)}const Ue=()=>{const i=T("#f1f3f5","#666666");return e(le,{get bgColor(){return i()},pos:"fixed",top:"0",left:"0",overflow:"hidden",zIndex:"-1",w:"100vw",h:"100vh"})},Ae=()=>{const i=y("sso_login_enabled"),o=v("sso_login_platform"),_=y("sso_compatibility_mode"),{searchParams:h,to:a}=H(),u=h.token;u!=null&&u!=""&&(C(u),a(decodeURIComponent(h.redirect||k||"/"),!0));function l(g){const n=g.data;n.token&&(C(n.token),a(decodeURIComponent(h.redirect||k||"/"),!0))}if(window.addEventListener("message",l),q(()=>{window.removeEventListener("message",l)}),i){const g=()=>{const m=b.getUri()+"/auth/sso?method=sso_get_token";if(_){window.location.href=m;return}window.open(m,"authPopup","width=500,height=600")};let n;switch(o){case"Github":n=pe;break;case"Microsoft":n=de;break;case"Google":n=ge;break;case"Dingtalk":n=ue;break;default:n=ce}return e(J,{cursor:"pointer",boxSize:"$8",as:n,p:"$0_5",onclick:g})}},ze=()=>{const i=v("logo").split(`
`);T(i[0],i.pop());const o=he(),_=me(()=>`${v("site_title")}`);Ie(_);const h=T("white","$neutral1"),[a,u]=p(localStorage.getItem("username")||""),[l,g]=p(localStorage.getItem("password")||""),[n,m]=p(""),[S,V]=p(!1),[$,W]=fe("remember-pwd","false"),[I,z]=p(!1),[Q,X]=U(async()=>I()?b.post("/auth/login/ldap",{username:a(),password:l(),otp_code:n()}):b.post("/auth/login/hash",{username:a(),password:Re(l()),otp_code:n()})),[,Y]=U((t,r,d,R)=>b.post("/authn/webauthn_finish_login?username="+d,JSON.stringify(r),{headers:{session:t},signal:R})),[,Z]=U((t,r)=>b.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:L,to:x}=H(),ee=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,B=y("webauthn_login_enabled"),te=async()=>{V(!S())};let s=null;const F=async t=>{if(!Le()){t||w.error(o("users.webauthn_not_supported"));return}if(t&&!await ee())return;s==null||s.abort();const r=new AbortController;s=r;const d=t?"":a();!t&&$()==="true"?localStorage.setItem("username",a()):localStorage.removeItem("username");const R=await Z(d,r.signal);ye(R,async N=>{try{const c=xe(N.options);c.signal=r.signal,t&&(c.mediation="conditional");const re=await Ee(c),se=await Y(N.session,re,d,r.signal);G(se,ae=>{w.success(o("login.success")),C(ae.token),x(decodeURIComponent(L.redirect||k||"/"),!0)})}catch(c){c instanceof Error&&c.name!="AbortError"&&w.error(c.message)}})},D=()=>s==null?void 0:s.abort();we(()=>{B&&(window.addEventListener("beforeunload",D),F(!0))}),q(()=>{s==null||s.abort(),window.removeEventListener("beforeunload",D)});const E=async()=>{if(S())await F();else{$()==="true"?(localStorage.setItem("username",a()),localStorage.setItem("password",l())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await X();G(t,r=>{w.success(o("login.success")),C(r.token),x(decodeURIComponent(L.redirect||k||"/"),!0)},(r,d)=>{!P()&&d===402?ne(!0):w.error(r)})}},[P,ne]=p(!1),K=y("ldap_login_enabled"),oe=v("ldap_login_tips");return K&&z(!0),e(ve,{zIndex:"1",w:"$full",h:"100vh",get children(){return[e(be,{get bgColor(){return h()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(A,{alignItems:"center",justifyContent:"space-around",get children(){return e(Ce,{color:"$info9",fontSize:"$2xl",get children(){return _()}})}}),e(f,{get when(){return!P()},get fallback(){return e(M,{id:"totp",name:"otp",get placeholder(){return o("login.otp-tips")},get value(){return n()},onInput:t=>m(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(M,{name:"username",get placeholder(){return o("login.username-tips")},get value(){return a()},onInput:t=>u(t.currentTarget.value)}),e(f,{get when(){return!S()},get children(){return e(M,{name:"password",get placeholder(){return o("login.password-tips")},type:"password",get value(){return l()},onInput:t=>g(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(A,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return e(j,{get checked(){return $()==="true"},onChange:()=>W($()==="true"?"false":"true"),get children(){return o("login.remember")}})}})]}}),e(ke,{w:"$full",spacing:"$2",get children(){return[e(f,{get when(){return!S()},get children(){return e(O,{colorScheme:"primary",w:"$full",onClick:()=>{P()?m(""):(u(""),g(""))},get children(){return o("login.clear")}})}}),e(O,{w:"$full",get loading(){return Q()},onClick:E,get children(){return o("login.login")}})]}}),e(f,{when:K,get children(){return e(j,{w:"$full",get checked(){return I()===!0},onChange:()=>z(!I()),children:oe})}}),e(O,{w:"$full",colorScheme:"accent",onClick:()=>{C(),x(decodeURIComponent(L.redirect||k||"/"),!0)},get children(){return o("login.use_guest")}}),e(A,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(_e,{}),e(Se,{}),e(Ae,{}),e(f,{when:B,get children(){return e(J,{cursor:"pointer",boxSize:"$8",as:$e,p:"$0_5",onclick:te})}})]}})]}}),e(Ue,{})]}})};export{ze as default};
