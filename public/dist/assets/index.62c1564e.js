import{cc as oe,Y as M,h as e,ab as re,aO as I,V as $,b as K,c8 as g,cd as S,e as se,aD as j,bg as b,bZ as ae,ce as ie,cf as le,cg as ce,ch as ue,a as ge,k as de,m as u,ci as pe,a$ as R,o as he,a8 as me,bS as A,aB as fe,S as f,I as E,b1 as F,ai as we,C as O,br as be,bs as Se,cj as ke,aH as Ce,n as w,bh as _e,ck as D}from"./index.ea8a3d40.js";import{a as $e}from"./useTitle.3b2ae23d.js";import{s as Ie,g as ye,a as ve}from"./webauthn-json.browser-ponyfill.1c672167.js";const xe="https://github.com/fcurrk/alist";function Le(s){return oe(`${s}-${xe}`)}const Pe=()=>{const s=M("#f1f3f5","#666666");return e(re,{get bgColor(){return s()},pos:"fixed",top:"0",left:"0",overflow:"hidden",zIndex:"-1",w:"100vw",h:"100vh"})},Re=()=>{const s=I("sso_login_enabled"),o=$("sso_login_platform"),k=I("sso_compatibility_mode"),{searchParams:d,to:r}=K(),l=d.token;l!=null&&l!=""&&(g(l),r(decodeURIComponent(d.redirect||S||"/"),!0));function i(c){const n=c.data;n.token&&(g(n.token),r(decodeURIComponent(d.redirect||S||"/"),!0))}if(window.addEventListener("message",i),se(()=>{window.removeEventListener("message",i)}),s){const c=()=>{const p=b.getUri()+"/auth/sso?method=sso_get_token";if(k){window.location.href=p;return}window.open(p,"authPopup","width=500,height=600")};let n;switch(o){case"Github":n=ue;break;case"Microsoft":n=ce;break;case"Google":n=le;break;case"Dingtalk":n=ie;break;default:n=ae}return e(j,{cursor:"pointer",boxSize:"$8",as:n,p:"$0_5",onclick:c})}},Me=()=>{const s=$("logo").split(`
`);M(s[0],s.pop());const o=ge(),k=de(()=>`${$("site_title")}`);$e(k);const d=M("white","$neutral1"),[r,l]=u(localStorage.getItem("username")||""),[i,c]=u(localStorage.getItem("password")||""),[n,p]=u(""),[C,G]=u(!1),[_,N]=pe("remember-pwd","false"),[y,U]=u(!1),[H,V]=R(async()=>y()?b.post("/auth/login/ldap",{username:r(),password:i(),otp_code:n()}):b.post("/auth/login/hash",{username:r(),password:Le(i()),otp_code:n()})),[,J]=R((t,a,h)=>b.post("/authn/webauthn_finish_login?username="+h,JSON.stringify(a),{headers:{session:t}})),[,W]=R(t=>b.get("/authn/webauthn_begin_login?username="+t)),{searchParams:v,to:x}=K(),q=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Y=I("webauthn_login_enabled"),Z=async()=>{G(!C())},T=async t=>{if(!Ie()){t||w.error(o("users.webauthn_not_supported"));return}if(t&&!await q())return;g();const a=t?"":r();!t&&_()==="true"?localStorage.setItem("username",r()):localStorage.removeItem("username");const h=await W(a);_e(h,async B=>{try{const m=ye(B.options);t&&(m.mediation="conditional");const ee=await ve(m),te=await J(B.session,ee,a);D(te,ne=>{w.success(o("login.success")),g(ne.token),x(decodeURIComponent(v.redirect||S||"/"),!0)})}catch(m){m instanceof Error&&w.error(m.message)}})},L=async()=>{if(C())await T();else{_()==="true"?(localStorage.setItem("username",r()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await V();D(t,a=>{w.success(o("login.success")),g(a.token),x(decodeURIComponent(v.redirect||S||"/"),!0)},(a,h)=>{!P()&&h===402?Q(!0):w.error(a)})}},[P,Q]=u(!1),z=I("ldap_login_enabled"),X=$("ldap_login_tips");return z&&U(!0),he(()=>{T(!0)}),e(Ce,{zIndex:"1",w:"$full",h:"100vh",get children(){return[e(me,{get bgColor(){return d()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(A,{alignItems:"center",justifyContent:"space-around",get children(){return e(fe,{color:"$info9",fontSize:"$2xl",get children(){return k()}})}}),e(f,{get when(){return!P()},get fallback(){return e(E,{id:"totp",name:"otp",get placeholder(){return o("login.otp-tips")},get value(){return n()},onInput:t=>p(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&L()}})},get children(){return[e(E,{name:"username",get placeholder(){return o("login.username-tips")},get value(){return r()},onInput:t=>l(t.currentTarget.value)}),e(f,{get when(){return!C()},get children(){return e(E,{name:"password",get placeholder(){return o("login.password-tips")},type:"password",get value(){return i()},onInput:t=>c(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&L()}})}}),e(A,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return e(F,{get checked(){return _()==="true"},onChange:()=>N(_()==="true"?"false":"true"),get children(){return o("login.remember")}})}})]}}),e(we,{w:"$full",spacing:"$2",get children(){return[e(f,{get when(){return!C()},get children(){return e(O,{colorScheme:"primary",w:"$full",onClick:()=>{P()?p(""):(l(""),c(""))},get children(){return o("login.clear")}})}}),e(O,{w:"$full",get loading(){return H()},onClick:L,get children(){return o("login.login")}})]}}),e(f,{when:z,get children(){return e(F,{w:"$full",get checked(){return y()===!0},onChange:()=>U(!y()),children:X})}}),e(O,{w:"$full",colorScheme:"accent",onClick:()=>{g(),x(decodeURIComponent(v.redirect||S||"/"),!0)},get children(){return o("login.use_guest")}}),e(A,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(be,{}),e(Se,{}),e(Re,{}),e(f,{when:Y,get children(){return e(j,{cursor:"pointer",boxSize:"$8",as:ke,p:"$0_5",onclick:Z})}})]}})]}}),e(Pe,{})]}})};export{Me as default};
