import{c7 as se,Y as F,h as e,ae,ad as y,V as $,b as G,c3 as b,c8 as C,e as ie,aF as j,bh as w,bU as le,c9 as ce,ca as ue,cb as ge,cc as de,a as pe,k as he,m as d,cd as me,b0 as R,o as fe,a8 as we,bN as U,aD as be,S as m,I as M,b2 as K,al as Ce,C as O,bs as Se,bt as ke,ce as _e,aJ as Ie,n as f,bi as $e,cf as N}from"./index-09b3847f.js";import{a as ye}from"./useTitle-e4a0c061.js";import{s as ve,g as xe,a as Le}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Ae="https://github.com/fcurrk/alist";function Ee(a){return se(`${a}-${Ae}`)}const Pe=()=>{const a=F("#f1f3f5","#666666");return e(ae,{get bgColor(){return a()},pos:"fixed",top:"0",left:"0",overflow:"hidden",zIndex:"-1",w:"100vw",h:"100vh"})},Re=()=>{const a=y("sso_login_enabled"),o=$("sso_login_platform"),S=y("sso_compatibility_mode"),{searchParams:p,to:s}=G(),c=p.token;c!=null&&c!=""&&(b(c),s(decodeURIComponent(p.redirect||C||"/"),!0));function i(u){const n=u.data;n.token&&(b(n.token),s(decodeURIComponent(p.redirect||C||"/"),!0))}if(window.addEventListener("message",i),ie(()=>{window.removeEventListener("message",i)}),a){const u=()=>{const h=w.getUri()+"/auth/sso?method=sso_get_token";if(S){window.location.href=h;return}window.open(h,"authPopup","width=500,height=600")};let n;switch(o){case"Github":n=de;break;case"Microsoft":n=ge;break;case"Google":n=ue;break;case"Dingtalk":n=ce;break;default:n=le}return e(j,{cursor:"pointer",boxSize:"$8",as:n,p:"$0_5",onclick:u})}},Fe=()=>{const a=$("logo").split(`
`);F(a[0],a.pop());const o=pe(),S=he(()=>`${$("site_title")}`);ye(S);const p=F("white","$neutral1"),[s,c]=d(localStorage.getItem("username")||""),[i,u]=d(localStorage.getItem("password")||""),[n,h]=d(""),[k,J]=d(!1),[_,V]=me("remember-pwd","false"),[v,T]=d(!1),[H,W]=R(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:i(),otp_code:n()}):w.post("/auth/login/hash",{username:s(),password:Ee(i()),otp_code:n()})),[,q]=R((t,r,g,P)=>w.post("/authn/webauthn_finish_login?username="+g,JSON.stringify(r),{headers:{session:t},signal:P})),[,Y]=R((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:x,to:L}=G(),Q=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,X=y("webauthn_login_enabled"),Z=async()=>{J(!k())};let I=null;const z=async t=>{if(!ve()){t||f.error(o("users.webauthn_not_supported"));return}if(t&&!await Q())return;I==null||I.abort();const r=new AbortController;I=r;const g=t?"":s();!t&&_()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const P=await Y(g,r.signal);$e(P,async D=>{try{const l=xe(D.options);l.signal=r.signal,t&&(l.mediation="conditional");const ne=await Le(l),oe=await q(D.session,ne,g,r.signal);N(oe,re=>{f.success(o("login.success")),b(re.token),L(decodeURIComponent(x.redirect||C||"/"),!0)})}catch(l){l instanceof Error&&l.name!="AbortError"&&f.error(l.message)}})},A=async()=>{if(k())await z();else{_()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await W();N(t,r=>{f.success(o("login.success")),b(r.token),L(decodeURIComponent(x.redirect||C||"/"),!0)},(r,g)=>{!E()&&g===402?ee(!0):f.error(r)})}},[E,ee]=d(!1),B=y("ldap_login_enabled"),te=$("ldap_login_tips");return B&&T(!0),fe(()=>{z(!0)}),e(Ie,{zIndex:"1",w:"$full",h:"100vh",get children(){return[e(we,{get bgColor(){return p()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(U,{alignItems:"center",justifyContent:"space-around",get children(){return e(be,{color:"$info9",fontSize:"$2xl",get children(){return S()}})}}),e(m,{get when(){return!E()},get fallback(){return e(M,{id:"totp",name:"otp",get placeholder(){return o("login.otp-tips")},get value(){return n()},onInput:t=>h(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&A()}})},get children(){return[e(M,{name:"username",get placeholder(){return o("login.username-tips")},get value(){return s()},onInput:t=>c(t.currentTarget.value)}),e(m,{get when(){return!k()},get children(){return e(M,{name:"password",get placeholder(){return o("login.password-tips")},type:"password",get value(){return i()},onInput:t=>u(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&A()}})}}),e(U,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return e(K,{get checked(){return _()==="true"},onChange:()=>V(_()==="true"?"false":"true"),get children(){return o("login.remember")}})}})]}}),e(Ce,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!k()},get children(){return e(O,{colorScheme:"primary",w:"$full",onClick:()=>{E()?h(""):(c(""),u(""))},get children(){return o("login.clear")}})}}),e(O,{w:"$full",get loading(){return H()},onClick:A,get children(){return o("login.login")}})]}}),e(m,{when:B,get children(){return e(K,{w:"$full",get checked(){return v()===!0},onChange:()=>T(!v()),children:te})}}),e(O,{w:"$full",colorScheme:"accent",onClick:()=>{b(),L(decodeURIComponent(x.redirect||C||"/"),!0)},get children(){return o("login.use_guest")}}),e(U,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Se,{}),e(ke,{}),e(Re,{}),e(m,{when:X,get children(){return e(j,{cursor:"pointer",boxSize:"$8",as:_e,p:"$0_5",onclick:Z})}})]}})]}}),e(Pe,{})]}})};export{Fe as default};
